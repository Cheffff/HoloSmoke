<!doctype html>
<html>
<head>
    <title>HoloSmoke</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="Copyright" content="&copy; 2013, Intel Corporation. All rights reserved." />
    <meta name="Author" content="Nabil - Olivier - Aymeric - Epitech" />
    <!--
     * Copyright (c) 2013, Intel Corporation. All rights reserved.
     * Please see http://software.intel.com/html5/license/samples
     * and the included README.md file for license terms and conditions.
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <link rel="stylesheet" type="text/css" href="css/index.css">

    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
    <script type="text/javascript" src="js/Google.js"></script>
    <script type="text/javascript" src="js/Camera.js"></script>
    <script type="text/javascript" src="js/Geolocation.js"></script>
    <script type="text/javascript" src="js/Compass.js"></script>
    <script type="text/javascript" src="js/Accelerometer.js"></script>

    <script src="lib/jquery/jquery-1.8.2.min.js"></script>
    <script src="cordova.js"></script>
    <script>

        var pin = [];
        var markersArray = [], bounds;
        var myLat = 0, myLng = 0;
        var bearing, distance;
        var dataStatus = 0;
        var latlng;

        // setup map and listen to deviceready
        $(document).ready(function () {
            document.addEventListener("deviceready", onDeviceReady, false);
        });
        // start device compass, accelerometer and geolocation after deviceready
        function onDeviceReady() {
            //fenetre de chargement
            cordova.plugin.pDialog.init({
                theme: 'HOLO_DARK',
                progressStyle: 'SPINNER',
                cancelable: true,
                title: 'Please Wait...',
                message: 'Loading ...'
            });

            //navigator.splashscreen.hide();

            //Start Application
            cordova.plugin.pDialog.setMessage('Loading Camera...');
            startCamera();

            cordova.plugin.pDialog.setMessage('Loading Map...');
            setupMap();

            cordova.plugin.pDialog.setMessage('Loading Accelerometre...');
            startAccelerometer();

            cordova.plugin.pDialog.setMessage('Loading Compass...');
            startCompass();

            cordova.plugin.pDialog.setMessage('Loading Geolocation...');
            startGeolocation();

            /*cordova.plugin.pDialog.setMessage('Loading Data...');
            StartData();*/
        }

        function toggleView() {
            if ($(".listView").is(":visible")) {
                $(".listView").hide();
                $("#map").height($(window).height() - 60);
                $(".mapView").fadeIn(
                    function () {
                        google.maps.event.trigger(map, "resize");
                        map.fitBounds(bounds);
                    });
                $("#viewbtn").html("List");
            } else {
                $(".mapView").hide();
                $(".listView").fadeIn();
                $("#viewbtn").html("Map");
            }
        }
        // get data from API and store in array, add to list view and create markers on map, calculate
        function loadData() {
            dataStatus = "loading";
            markersArray = [];
            bounds = new google.maps.LatLngBounds();
            // add blue gps marker
            var icon = new google.maps.MarkerImage('http://www.google.com/intl/en_us/mapfiles/ms/micons/blue-dot.png', new google.maps.Size(30, 28), new google.maps.Point(0, 0), new google.maps.Point(9, 28));
            var gpsMarker = new google.maps.Marker({ position: new google.maps.LatLng(myLat, myLng), map: map, title: "My Position", icon: icon });
            bounds.extend(new google.maps.LatLng(myLat, myLng));
            markersArray.push(gpsMarker);
            // add all location markers to map and list view and array
            for (var i = 0; i < pin.length; i++) {
                $(".listItems").append("<div class='item'>" + pin[i].name + "</div>");
                addMarker(i);
                relativePosition(i);
            }
            map.fitBounds(bounds);
            google.maps.event.trigger(map, "resize");
            dataStatus = "loaded";
        }

        // add marker to map and in array
        function addMarker(i) {
            var marker = new google.maps.Marker({ position: new google.maps.LatLng(pin[i].lat, pin[i].lng), map: map, title: pin[i].name });
            bounds.extend(new google.maps.LatLng(pin[i].lat, pin[i].lng));
            markersArray.push(marker);
        }

        // clear all markers from map and array
        function clearMarkers() {
            while (markersArray.length) {
                markersArray.pop().setMap(null);
            }
        }
        // calulate distance and bearing value for each of the points wrt gps lat/lng
        function relativePosition(i) {
            var pinLat = pin[i].lat;
            var pinLng = pin[i].lng;
            var dLat = (myLat - pinLat) * Math.PI / 180;
            var dLon = (myLng - pinLng) * Math.PI / 180;
            var lat1 = pinLat * Math.PI / 180;
            var lat2 = myLat * Math.PI / 180;
            var y = Math.sin(dLon) * Math.cos(lat2);
            var x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = bearing + 180;
            pin[i]['bearing'] = bearing;

            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            distance = 6371010 * c;
            pin[i]['distance'] = distance;
        }
        // calculate direction of points and display
        function calculateDirection(degree) {
            var detected = 0;
            $("#spot").html("");
            for (var i = 0; i < pin.length; i++) {
                if (Math.abs(pin[i].bearing - degree) <= 20) {
                    var away, fontSize, fontColor;
                    // varry font size based on distance from gps location
                    if (pin[i].distance > 1500) {
                        away = Math.round(pin[i].distance);
                        fontSize = "16";
                        fontColor = "#ccc";
                    } else if (pin[i].distance > 500) {
                        away = Math.round(pin[i].distance);
                        fontSize = "24";
                        fontColor = "#ddd";
                    } else {
                        away = pin[i].distance.toFixed(2);
                        fontSize = "30";
                        fontColor = "#eee";
                    }
                    $("#spot").append('<div class="name" data-id="' + i + '" style="margin-left:' + (((pin[i].bearing - degree) * 5) + 50) + 'px;width:' + ($(window).width() - 100) + 'px;font-size:' + fontSize + 'px;color:' + fontColor + '">' + pin[i].name + '<div class="distance">' + away + ' mètre(s) de distance</div></div>');
                    detected = 1;
                } else {
                    if (!detected) {
                        $("#spot").html("");
                    }
                }
            }

        }

        function doSnapshot() {
            //hide snapbtn so it will not be in snapshot image
            document.getElementById("snapbtn").style.display = "none";

            //give dom chance to hide snapbtn before image capture
            setTimeout(function () {
                ezar.snapshot(
                    function (data) {
                        alert("Snapshot complete.\nSee Gallery for image");
                        document.getElementById("snapbtn").style.display = "block";
                    },
                    function (err) {
                        alert("Error: " + err);
                        document.getElementById("snapbtn").style.display = "block";
                    },
                    { "saveToPhotoAlbum": true }
                )
            }, 10);
        }
    </script>
</head>
<body id="body" style="background-color: transparent">
    <div id="arView" style="background-color: transparent">
        <div class="arMessage">&uarr;<br>Baissez votre téléphone pour voir tous les résultats</div>
        <br>
        <div class="arMessage">&larr; Tournez votre téléphone autour de vous &rarr;</div>
        <br>
        <div id="direction"></div>
        <br>
        <div id="spot"></div>
        <div class="snap" onclick="doSnapshot()">
            <img id="snapbtn" src="img/camera_btn.png">
        </div>
        <div class="attributing">
            HoloSmoke
        </div>
    </div>
    <div id="topView" style="background-color: white">
        <div class="navbar">
            <!--<div id="actionbtn" class="navbtn"> &crarr; </div>-->
            <div id="viewbtn" class="navbtn" onclick="toggleView()">Map</div>
            <div class="navtitle">HoloSmoke</div>
        </div>
        <div class="listView">
            <div class="listItems"></div>
        </div>
        <div class="mapView">
            <div id="map"></div>
        </div>
    </div>
    <div id="debug">
        <div class="heading">Geolocation</div>
        <div id="geolocation"></div>
        <div class="heading">Compass</div>
        <div id="compass"></div>
        <div class="heading">Accelerometer</div>
        <div id="accelerometer"></div>
        <div class="heading">Log</div>
        <div id="log"></div>
    </div>
</body>
</html>